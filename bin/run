#!/bin/bash

# bin/run - Build and run the app on connected device/emulator
# Usage: bin/run [--release]

set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Default to debug build
BUILD_TYPE="debug"
GRADLE_TASK="installDebug"

# Parse arguments
if [[ "$1" == "--release" ]]; then
    BUILD_TYPE="release"
    GRADLE_TASK="installRelease"
fi

echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}Building and installing app (${BUILD_TYPE})${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
echo ""

# Check for physical devices (prefer them over emulators)
PHYSICAL_DEVICES=$(adb devices | grep -v "List" | grep "device" | grep -v "emulator-" | wc -l)
EMULATORS=$(adb devices | grep -v "List" | grep "device" | grep "emulator-" | wc -l)
TOTAL_DEVICES=$(adb devices | grep -v "List" | grep "device" | wc -l)

# If physical device is connected, use it (and optionally kill emulator to save resources)
if [ "$PHYSICAL_DEVICES" -gt 0 ]; then
    DEVICE_NAME=$(adb devices -l | grep -v "List" | grep "device" | grep -v "emulator-" | head -1 | awk '{print $1}')
    echo -e "${GREEN}✓ Physical device detected: $DEVICE_NAME${NC}"

    # If an emulator is also running, kill it to save resources
    if [ "$EMULATORS" -gt 0 ]; then
        echo -e "${YELLOW}Stopping emulator to save CPU/RAM...${NC}"
        # Kill all running emulators
        adb devices | grep "emulator-" | awk '{print $1}' | while read -r emu; do
            adb -s "$emu" emu kill 2>/dev/null || true
        done
        sleep 1
        echo -e "${GREEN}✓ Emulator stopped${NC}"
    fi
    echo ""

# If only emulator is connected, use it
elif [ "$EMULATORS" -gt 0 ]; then
    echo -e "${BLUE}Using emulator${NC}"
    echo ""

# If nothing is connected, start an emulator
elif [ "$TOTAL_DEVICES" -eq 0 ]; then
    echo -e "${YELLOW}No device or emulator connected. Starting emulator...${NC}"
    echo ""

    # Try to find Android SDK
    if [ -z "$ANDROID_HOME" ]; then
        # Common locations
        if [ -d "$HOME/Library/Android/sdk" ]; then
            ANDROID_HOME="$HOME/Library/Android/sdk"
        elif [ -d "/usr/local/share/android-sdk" ]; then
            ANDROID_HOME="/usr/local/share/android-sdk"
        elif [ -d "/opt/android-sdk" ]; then
            ANDROID_HOME="/opt/android-sdk"
        else
            echo -e "${RED}✗ Android SDK not found${NC}"
            echo ""
            echo "Please either:"
            echo "  1. Set ANDROID_HOME: export ANDROID_HOME=/path/to/android/sdk"
            echo "  2. Connect a physical device via USB"
            echo "  3. Install Android Studio which includes the SDK"
            exit 1
        fi
    fi

    EMULATOR="$ANDROID_HOME/emulator/emulator"

    if [ ! -f "$EMULATOR" ]; then
        echo -e "${RED}✗ Emulator not found at: $EMULATOR${NC}"
        echo ""
        echo "Please install Android Emulator or connect a physical device"
        exit 1
    fi

    # Get list of available AVDs
    AVDS=$("$EMULATOR" -list-avds)

    if [ -z "$AVDS" ]; then
        echo -e "${RED}✗ No Android Virtual Devices (AVDs) found${NC}"
        echo ""
        echo "Please create an AVD in Android Studio or connect a physical device"
        exit 1
    fi

    # Use the first AVD
    FIRST_AVD=$(echo "$AVDS" | head -n 1)

    echo -e "${GREEN}Starting emulator: $FIRST_AVD${NC}"
    echo ""

    # Start emulator in background
    "$EMULATOR" -avd "$FIRST_AVD" > /dev/null 2>&1 &

    echo -e "${YELLOW}Waiting for emulator to boot...${NC}"
    adb wait-for-device

    # Wait for boot to complete
    echo -e "${YELLOW}Waiting for Android to finish booting...${NC}"
    while [ "$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')" != "1" ]; do
        sleep 1
    done

    echo -e "${GREEN}✓ Emulator is ready!${NC}"
    echo ""
fi

echo -e "${BLUE}Connected devices:${NC}"
adb devices
echo ""

# Build and install
./gradlew "$GRADLE_TASK" --console=plain

if [ $? -eq 0 ]; then
    echo ""
    echo -e "${GREEN}✓ App installed successfully!${NC}"
    echo ""
    echo -e "${YELLOW}Launching app...${NC}"

    # Launch the app
    adb shell am start -n com.robotomator.app/.MainActivity

    echo ""
    echo -e "${GREEN}App is running!${NC}"
    echo ""
    echo "To view logs:"
    echo "  adb logcat -s RobotomatorA11yService:* MainActivity:*"
else
    echo ""
    echo -e "${RED}✗ Installation failed${NC}"
    exit 1
fi
