#!/bin/bash

# bin/test - Run Android tests with various options
# Usage: bin/test [--debug|--release] [--connected]

set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Default values
VARIANT="debug"
CONNECTED=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --debug)
            VARIANT="debug"
            shift
            ;;
        --release)
            VARIANT="release"
            shift
            ;;
        --connected)
            CONNECTED=true
            shift
            ;;
        --help|-h)
            echo "Usage: bin/test [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --debug      Run debug unit tests (default)"
            echo "  --release    Run release unit tests"
            echo "  --connected  Run instrumented tests on connected device/emulator"
            echo "  --help, -h   Show this help message"
            echo ""
            echo "Examples:"
            echo "  bin/test                    # Run debug unit tests"
            echo "  bin/test --release          # Run release unit tests"
            echo "  bin/test --connected        # Run instrumented tests on device"
            echo "  bin/test --debug --connected # Run debug instrumented tests"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Run 'bin/test --help' for usage information"
            exit 1
            ;;
    esac
done

# Determine which task to run
if [ "$CONNECTED" = true ]; then
    if [ "$VARIANT" = "debug" ]; then
        TASK="connectedDebugAndroidTest"
        DESCRIPTION="Debug instrumented tests on connected device"
    else
        TASK="connectedReleaseAndroidTest"
        DESCRIPTION="Release instrumented tests on connected device"
    fi
else
    if [ "$VARIANT" = "debug" ]; then
        TASK="testDebugUnitTest"
        DESCRIPTION="Debug unit tests"
    else
        TASK="testReleaseUnitTest"
        DESCRIPTION="Release unit tests"
    fi
fi

echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}Running: ${DESCRIPTION}${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
echo ""

# Run the tests with console output
./gradlew "$TASK" --console=plain

# Check exit code
if [ $? -eq 0 ]; then
    echo ""
    echo -e "${GREEN}✓ Tests passed!${NC}"
    echo ""

    # Show report location for unit tests
    if [ "$CONNECTED" = false ]; then
        # Capitalize first letter of variant for path
        VARIANT_FIRST=$(echo "${VARIANT:0:1}" | tr '[:lower:]' '[:upper:]')
        VARIANT_REST="${VARIANT:1}"
        REPORT_PATH="app/build/reports/tests/test${VARIANT_FIRST}${VARIANT_REST}UnitTest/index.html"
        if [ -f "$REPORT_PATH" ]; then
            echo -e "${YELLOW}Test report: $REPORT_PATH${NC}"
        fi
    fi
else
    echo ""
    echo -e "${RED}✗ Tests failed${NC}"
    exit 1
fi
